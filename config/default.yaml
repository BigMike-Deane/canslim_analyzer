# CANSLIM Analyzer Default Configuration
# Override these values in development.yaml or production.yaml

# Scanner Settings
scanner:
  workers: 8
  delay_min: 0.5  # seconds between API calls (min)
  delay_max: 1.0  # seconds between API calls (max)
  batch_size: 75  # Increased from 50 for better throughput
  max_retries: 2
  skip_fresh_stocks: true  # Skip stocks scanned within freshness_minutes
  freshness_minutes: 30  # Minimum age before re-scanning a stock

# Cache Settings
cache:
  # Redis cache
  redis:
    enabled: true
    host: localhost
    port: 6379
    db: 0
    decode_responses: true

  # Data freshness intervals (seconds)
  freshness_intervals:
    price: 0                # Always fetch (real-time)
    earnings: 86400         # 24 hours
    revenue: 86400          # 24 hours
    balance_sheet: 86400    # 24 hours
    key_metrics: 86400      # 24 hours
    analyst: 86400          # 24 hours
    earnings_surprise: 86400  # 24 hours
    weekly_history: 86400   # 24 hours
    institutional: 604800   # 7 days (1 week)
    insider_trading: 604800 # 7 days
    short_interest: 86400   # 24 hours

  # In-memory cache limits
  max_cached_tickers: 2500  # Need room for ~2100 tickers × ~10 data types
  market_cache_duration: 14400  # 4 hours

# CANSLIM Scoring Weights
scoring:
  canslim:
    max_scores:
      C: 15  # Current Quarterly Earnings
      A: 15  # Annual Earnings Growth
      N: 15  # New Highs
      S: 15  # Supply & Demand
      L: 15  # Leader vs Laggard
      I: 10  # Institutional Ownership
      M: 15  # Market Direction

    # C Score (Current Earnings) weights
    c_weights:
      base_max: 10          # TTM growth
      acceleration_max: 5   # EPS acceleration bonus (increased - strong predictor)
      surprise_max: 2       # Earnings surprise bonus

    # Sector-adjusted growth thresholds
    # A 20% growth for Industrial is excellent; for Tech it's mediocre
    sector_thresholds:
      Technology:
        excellent: 30
        good: 20
      Healthcare:
        excellent: 25
        good: 15
      Industrials:
        excellent: 20
        good: 12
      Utilities:
        excellent: 12
        good: 8
      default:
        excellent: 25
        good: 15

    # Institutional ownership thresholds (expanded from 20-60 to 25-75)
    institutional:
      ideal_min: 25
      ideal_max: 75
      partial_min: 15
      partial_max: 85

    # A Score (Annual Earnings) weights
    a_weights:
      cagr_max: 12         # 3-year CAGR
      roe_max: 3           # ROE quality bonus

    # Thresholds
    thresholds:
      min_score: 30        # Skip stocks below this score
      roe_excellent: 25    # ROE >= 25% = excellent
      roe_good: 17         # ROE >= 17% = good
      ttm_growth_excellent: 25  # >= 25% TTM growth = max score

  growth_mode:
    max_scores:
      R: 20  # Revenue Growth
      F: 15  # Funding/Financial Health
      N: 15  # New Highs
      S: 15  # Supply & Demand
      L: 15  # Leader vs Laggard
      I: 10  # Institutional Ownership
      M: 10  # Market Direction

    # Growth Mode activation criteria
    criteria:
      min_revenue_growth: 50  # >= 50% YoY = high growth
      min_profit_margin: 0.01 # < 1% margin = early stage

# Market Direction Settings
market:
  indexes:
    SPY:
      weight: 0.50  # S&P 500 - broad market
      name: "S&P 500"
    QQQ:
      weight: 0.30  # NASDAQ 100 - tech/growth
      name: "NASDAQ 100"
    DIA:
      weight: 0.20  # Dow Jones - blue chips
      name: "Dow Jones"

  # Signal scoring
  signals:
    strong_bullish: 2
    bullish: 1
    neutral: 0
    bearish: -1

# AI Trader Settings
ai_trader:
  # Portfolio allocation limits
  allocation:
    min_cash_reserve_pct: 0.10    # Default cash reserve (overridden by dynamic regime-based reserves)
    # Dynamic cash reserves by market regime (replaces fixed 10%)
    cash_reserve_strong_bull: 0.05   # 5% — almost fully invested
    cash_reserve_bull: 0.10          # 10% — standard
    cash_reserve_neutral: 0.20       # 20% — uncertain market
    cash_reserve_bear: 0.40          # 40% — significantly reduced exposure
    cash_reserve_strong_bear: 0.60   # 60% — mostly cash, only pilot trades
    max_sector_allocation: 0.50   # Max 50% in any sector (O'Neil: follow best sectors, manage risk via stops)
    max_stocks_per_sector: 4      # Max 4 stocks per sector
    max_single_position: 0.25     # Max 25% in single stock (Minervini: 4 stocks at 25% = fully invested)
    min_score_to_buy: 72          # Minimum CANSLIM score to buy (raised from 65)
    # Soft buy threshold: stocks scoring just below min_score get graduated position sizes
    # instead of binary skip. Reduces sensitivity to FMP data variance on C/A scores.
    soft_threshold:
      enabled: true
      zone_width: 8              # Score 64-71 when min_score=72 (widened from 4 for FMP resilience)
      multiplier_at_edge: 0.25   # Score 64 → 25% position
      multiplier_at_top: 0.75    # Score 71 → 75% position
      # H: Only allow wide soft zone for stocks with strong deterministic scores
      require_strong_deterministic: true
      deterministic_min: 50      # N+S+L+I+M >= 50 (out of 70) to qualify for soft zone
    percentile_threshold_pct: 5   # Use top N% of stocks as adaptive threshold
    percentile_score_floor: 45    # Never buy below this score regardless of percentile

  # Stock selection quality filters - must meet ALL criteria
  quality_filters:
    min_c_score: 10               # Strong current earnings (max 15)
    min_l_score: 8                # Strong relative strength (max 15)
    min_volume_ratio: 1.2         # Accumulation signal (1.2x avg volume)
    skip_in_growth_mode: true     # Don't apply C/L filters to growth stocks

  # Earnings calendar avoidance for non-CS stocks
  # CS stocks use their own allow_buy_days from coiled_spring config
  earnings:
    avoidance_days: 5             # Block non-CS stocks within 5 days of earnings
    cs_override: true             # Allow CS stocks to override avoidance

  # Earnings Audit: Deep FMP fundamental check for buy candidates
  # Runs between scan and AI trading to enrich composite scores
  earnings_audit:
    enabled: true
    max_candidates: 30              # Top N candidates to audit per cycle
    freshness_hours: 24             # Re-audit after this many hours
    weights:
      analyst_upside: 0.20          # 20pts: Analyst price target upside
      beat_quality: 0.25            # 25pts: Earnings beat streak + magnitude
      financial_health: 0.20        # 20pts: ROE, debt/equity, FCF
      insider_conviction: 0.15      # 15pts: Insider cluster buys + net value
      estimate_revisions: 0.20      # 20pts: EPS/revenue revision trend
    bonus_thresholds:
      high_confidence: 70           # >= 70 confidence → +10 composite
      high_bonus: 10
      medium_confidence: 50         # >= 50 confidence → +5 composite
      medium_bonus: 5
      low_confidence: 30            # < 30 confidence → -5 composite
      low_penalty: -5

  # Analyst revision bonus (estimate revisions)
  analyst_revisions:
    enabled: true
    strong_up_threshold: 10       # >= 10% revision = strong up
    strong_up_bonus: 5            # +5 points
    mod_up_bonus: 3               # 5-10% revision = +3 points
    strong_down_threshold: -10    # <= -10% revision = strong down
    strong_down_penalty: -5       # -5 points
    mod_down_penalty: -2          # -5 to -10% revision = -2 points

  # Market regime detection (adjusts position sizes based on market conditions)
  market_regime:
    enabled: true
    bullish_threshold: 1.5        # weighted_signal >= this = bullish
    bearish_threshold: -0.5       # weighted_signal <= this = bearish
    bullish_max_position_pct: 15.0  # Allow larger positions in bull market
    neutral_max_position_pct: 12.0  # Standard position sizing
    bearish_max_position_pct: 8.0   # Smaller positions in bear market
    bearish_min_score_adj: 10      # Require 10 more points in bear market (raised from 5)
    bear_exception_min_cal: 35     # Min C+A+L score to bypass bearish adjustment
    bear_exception_position_mult: 0.50  # 50% position size for bear market exceptions

  # Drawdown protection (reduce position sizes when portfolio is down)
  drawdown_protection:
    enabled: true
    level_1_threshold: 10         # >= 10% drawdown = reduce 25%
    level_1_multiplier: 0.75
    level_2_threshold: 15         # >= 15% drawdown = reduce 50%
    level_2_multiplier: 0.50

  # Sector rotation (bonus for leading sectors, penalty for lagging)
  sector_rotation:
    enabled: true
    leading_l_score: 10           # Avg L >= 10 = leading sector
    lagging_l_score: 5            # Avg L < 5 = lagging sector
    leading_bonus: 5              # +5 points for leading sectors
    lagging_penalty: -3           # -3 points for lagging sectors

  # Portfolio correlation (reduce position for concentrated sectors/industries)
  correlation:
    enabled: true
    sector_threshold: 3           # >= 3 stocks in sector = reduce position
    sector_multiplier: 0.85       # 15% smaller if same sector
    industry_threshold: 2         # >= 2 stocks in same industry = reduce more
    industry_multiplier: 0.70     # 30% smaller if same industry

  # Entry bonuses - pre-breakout is optimal entry (before the crowd)
  entry_bonuses:
    pre_breakout: 30     # 5-15% below pivot with base (best entry)
    at_pivot: 25         # 0-5% below pivot with base
    breakout: 20         # 0-5% above pivot (confirmed but slightly extended)

  # Position size multipliers based on entry type
  position_multipliers:
    pre_breakout: 1.30   # 30% larger for optimal pre-breakout entry
    at_pivot: 1.20       # 20% larger for at-pivot entries
    breakout: 1.15       # 15% larger for confirmed breakouts

  # Score crash sell requirements
  score_crash:
    consecutive_required: 3           # Require 3+ consecutive low scans before selling (was 2)
    threshold: 50                     # Score must be below this threshold
    drop_required: 20                 # Score must have dropped by this much
    ignore_if_profitable_pct: 10      # Skip score crash sell if position is up this much %

  # Partial profit taking - lock in gains while letting winners run
  partial_profits:
    enabled: true
    threshold_25pct:
      gain_pct: 25         # Take partial at 25% gain
      sell_pct: 25         # Sell 25% of position
      min_score: 60        # Only if score still strong
    threshold_40pct:
      gain_pct: 40         # Take more at 40% gain
      sell_pct: 50         # Sell 50% total (25% additional)
      min_score: 60        # Only if score still strong

  # Momentum confirmation
  momentum_confirmation:
    rs_ratio_threshold: 0.95  # rs_3m must be >= rs_12m * 0.95
    penalty: 0.15             # 15% penalty to composite score if fading

  # Re-entry cooldown (prevent same-day re-buys after stops)
  re_entry_cooldown:
    stop_loss_days: 5                 # Days to wait after stop loss before re-buying
    trailing_stop_days: 3             # Days to wait after trailing stop before re-buying

  # Drawdown protection (portfolio-level circuit breaker)
  drawdown_protection:
    halt_new_buys_pct: 15.0           # Stop buying when portfolio down 15% from peak
    liquidate_all_pct: 25.0           # Emergency: sell everything at 25% drawdown
    recovery_pct: 10.0                # Resume buying when drawdown recovers below 10%

  # Score stability: override soft-zone graduated sizing for stocks with strong
  # deterministic (non-FMP) scores (N+S+L+I+M = 70pts max).
  # When stable_score >= threshold, use multiplier_at_top regardless of total score.
  score_stability:
    enabled: true
    stable_min_for_override: 55   # Out of 70 max (N+S+L+I+M)

  # Market regime gate: skip buys when SPY < 50MA (bearish regime)
  market_regime_gate:
    enabled: true                    # Don't buy when SPY below 50-day MA

  # Conviction-based position sizing: higher scores get larger positions
  # Uses composite_score (typically 25-75 range, not CANSLIM 0-100)
  conviction_sizing:
    enabled: true                    # Re-enabled: data shift was the real cause, not sizing
    min_pct: 8.0                     # Floor: lowest-conviction positions
    max_pct: 20.0                    # Ceiling: highest-conviction positions
    score_floor: 30                  # Composite score at which min_pct applies
    score_ceiling: 75                # Composite score at which max_pct applies
    skip_initial_seeds: true         # G: Don't use conviction sizing for day-1 seed positions

  # New Position Guard: tighter stop loss for new positions in their first N days
  # Cuts early losers faster (POWL -22% in 14d, GDDY -14% in 7d)
  new_position_guard:
    enabled: true
    guard_days: 21                   # F: Apply tighter stop for first 21 days
    guard_stop_pct: 8.0              # F: 8% max loss for new positions (vs normal ATR-adjusted)
    skip_if_pyramided: true          # Don't apply guard if position has been pyramided (proven winner)

  # Deterministic score boost: bonus to composite for stocks with strong
  # non-FMP scores (N+S+L+I+M). Reduces FMP influence on ranking/sizing.
  deterministic_boost:
    enabled: true
    stable_bonus_threshold: 55   # N+S+L+I+M >= 55 → +5 to composite
    stable_bonus: 5
    strong_threshold: 60         # N+S+L+I+M >= 60 → +8 to composite
    strong_bonus: 8

  # Stop loss settings
  stops:
    normal_stop_loss_pct: 8.0          # O'Neil: cut losses at 7-8%, no exceptions
    bearish_stop_loss_pct: 7.0        # Tighter in bear (Minervini: tighter stops in difficult markets)
    use_atr_stops: true               # Use ATR-based adaptive stop losses
    atr_multiplier: 2.5               # Stop = max(config_stop, ATR * multiplier)
    atr_period: 14                    # ATR lookback period in days
    max_stop_pct: 20.0                # Maximum stop loss percentage (cap)

  # Trailing stop loss thresholds
  trailing_stops:
    gain_50_plus:
      threshold: 0.50    # 50%+ gain
      stop_pct: 0.15     # 15% trailing stop
    gain_30_to_50:
      threshold: 0.30
      stop_pct: 0.12     # 12% trailing stop
    gain_20_to_30:
      threshold: 0.20
      stop_pct: 0.10     # 10% trailing stop
    gain_10_to_20:
      threshold: 0.10
      stop_pct: 0.08     # 8% trailing stop
    # Partial sell on trailing stop for high-conviction positions
    partial_on_trailing: true           # Enable partial sell on trailing stop hit
    partial_min_pyramid_count: 2        # Min pyramids to qualify for partial
    partial_min_score: 65               # Min score to qualify for partial
    partial_sell_pct: 50                # Sell this % of position, keep remainder

  # Insider trading signal weights
  insider_signals:
    bullish_bonus: 5      # +5 points for bullish insiders
    bearish_penalty: -3   # -3 points for bearish insiders
    buy_sell_ratio: 1.5   # Buys > 1.5x sells = bullish
    # Insider cluster detection (multiple insiders buying)
    cluster_bonus: 8               # Bonus for 3+ insider buys
    high_value_cluster_bonus: 12   # Bonus for 3+ buys totaling $1M+
    csuite_bonus: 3                # Extra bonus for C-suite buying

  # Short interest settings
  short_interest:
    high_threshold: 0.20  # > 20% short interest
    high_penalty: -5
    medium_threshold: 0.10  # > 10% short interest
    medium_penalty: -2

  # Short squeeze detection
  # High short interest can be opportunity with right setup
  short_squeeze:
    enabled: true
    min_short_pct: 20             # Min short interest to consider squeeze
    min_l_score: 10               # Must have strong relative strength
    squeeze_bonus: 5              # Bonus for squeeze setup (instead of penalty)

# Coiled Spring / Earnings Catalyst Detection
# Identifies stocks with explosive earnings potential based on:
# - Long consolidation (stored energy)
# - Consistent earnings beats
# - Low institutional ownership (room to buy)
# - Rising relative strength
coiled_spring:
  # ALL criteria must be met to qualify
  thresholds:
    min_weeks_in_base: 15       # Long consolidation = stored energy
    min_beat_streak: 3          # Consistent execution
    min_c_score: 10             # Strong current earnings (relaxed from 12)
    min_total_score: 55         # Quality stock
    max_institutional_pct: 75   # Room for institutions to buy (relaxed from 50)
    min_l_score: 6              # Rising relative strength (relaxed from 8)

  # Relaxed thresholds for PRE-BREAKOUT candidates (haven't had catalyst yet)
  pre_breakout_thresholds:
    min_c_score: 5              # Lower C requirement (catalyst hasn't happened)
    min_total_score: 48         # Lower total (will improve after earnings)
    min_beat_streak: 3          # Same consistency requirement

  # Earnings timing
  earnings_window:
    alert_days: 14              # Start tracking 14 days out
    allow_buy_days: 7           # Allow buys up to 7 days before (override 3-day block)
    block_days: 1               # Never buy within 1 day of earnings

  # Scoring bonus
  scoring:
    base_bonus: 20              # Base bonus when criteria met
    long_base_bonus: 10         # Extra for 20+ week base
    strong_beat_bonus: 5        # Extra for 5+ consecutive beats
    max_bonus: 35               # Cap total CS bonus

  # Quality ranking weights (used to rank candidates, higher = better)
  ranking_weights:
    weeks_in_base: 1.5          # Longer base = more stored energy
    beat_streak: 3.0            # Consistency is key
    l_score: 2.0                # Relative strength momentum
    total_score: 0.5            # Overall quality
    low_inst_bonus: 10          # Bonus if inst < 30% (room to run)
    pre_breakout_bonus: 15      # Bonus if NOT already breaking out (ideal entry)
    extended_penalty: -20       # Penalty if already extended (>5% above pivot with high volume)

  # Alert settings (prevent overload)
  alerts:
    enabled: true
    max_per_day: 5              # Maximum alerts per day (increased from 3)
    cooldown_hours: 8           # Hours between alerts for same ticker
    include_in_email: true
    min_price_change_pct: 3     # Require 3% price move from previous alert to re-alert same ticker

  # Position sizing
  position_multiplier: 1.25     # 25% larger position for CS plays

  # Outcome tracking (auto-update CS alert outcomes after earnings)
  outcome_tracking:
    enabled: true
    check_days_after_earnings: 3   # Days to wait after earnings to check outcome
    thresholds:
      big_win_pct: 15    # >= 15% gain = big_win
      win_pct: 5         # >= 5% gain = win
      loss_pct: -5       # <= -5% = loss
      # Between -5% and +5% = flat

# Watchlist Alerts
watchlist:
  alerts:
    enabled: true
    check_after_scan: true       # Check alerts after each scan completes
    cooldown_hours: 24           # Don't re-alert for same item within 24h

# Technical Analysis Settings
technical:
  # Base pattern detection
  base_patterns:
    flat_base:
      min_weeks: 5
      max_range_pct: 0.15  # < 15% weekly range
    cup_with_handle:
      min_decline_pct: 0.15  # >= 15% decline
      handle_min_pct: 0.05   # 5-15% handle pullback
      handle_max_pct: 0.15
      handle_max_weeks: 4
    double_bottom:
      min_recovery_pct: 0.10  # >= 10% recovery between lows
      low_tolerance_pct: 0.03 # Lows within 3% of each other

  # Breakout detection
  breakout:
    volume_threshold: 1.5     # 1.5x average volume
    pivot_proximity_pct: 0.05  # Within 5% of pivot
    confirmation_score: 60     # Min volume confirmation score

# Stock Universe Settings
universe:
  sources:
    - sp500        # S&P 500
    - sp400        # S&P MidCap 400
    - sp600        # S&P SmallCap 600
    - russell2000  # Russell 2000

  # Duplicate ticker handling
  duplicates:
    GOOG: GOOGL  # Keep GOOGL, filter GOOG

# API Rate Limits
api:
  fmp:
    rate_limit: 300  # calls per minute
    timeout: 10      # seconds
  yahoo:
    delay: 0.3       # seconds between calls
    timeout: 15      # seconds
  finviz:
    delay: 1.0       # seconds between scrapes
    timeout: 10      # seconds

# API Response Limits
api_limits:
  default_page_size: 50
  max_page_size: 500
  default_history_days: 30
  max_history_days: 365

# Scoring Defaults
scoring_defaults:
  min_displayable_score: 30
  default_market_score: 10

# Retry Settings
retry:
  max_attempts: 3
  base_delay_seconds: 1
  max_delay_seconds: 30

# Alert Thresholds
alerts:
  price_change_significant_pct: 5
  volume_spike_ratio: 2.0

# Notifications
notifications:
  # Webhook notifications (push notifications via ntfy.sh, Pushover, etc.)
  webhook:
    enabled: true
    # Set CANSLIM_WEBHOOK_URL environment variable to enable
    # Example: https://ntfy.sh/your-topic
    url_env_var: "CANSLIM_WEBHOOK_URL"
    priority: "high"             # Priority for CS alerts

  # Weekly performance email (sent Saturday 9 AM)
  weekly_email:
    enabled: true
    day_of_week: "sat"           # Day to send (mon, tue, wed, thu, fri, sat, sun)
    hour: 9                      # Hour to send (0-23)

# Database Settings
database:
  # Indexes for optimization
  indexes:
    - name: ix_stocks_canslim
      column: canslim_score
    - name: ix_stocks_price
      column: current_price
    - name: ix_stocks_score_price
      columns: [canslim_score, current_price]

# Market Timing (O'Neil's system: A/D days + Follow-Through Days)
market_timing:
  # Accumulation/Distribution Day Tracking
  accumulation_distribution:
    enabled: true
    lookback_days: 25                  # Rolling window for A/D day count
    distribution_threshold: 4          # 4-5 distribution days in 25 = go defensive
    critical_threshold: 5              # 5+ distribution days = go to cash
    # A distribution day: index down 0.2%+ on higher volume than prior day
    min_decline_pct: 0.2               # Minimum decline for distribution day
    # An accumulation day: index up 0.2%+ on higher volume than prior day
    min_advance_pct: 0.2               # Minimum advance for accumulation day

  # ============================================================
  # DISABLED FEATURES — Backtested in runs #42-#46. All filtering
  # and blocking features hurt returns in bullish markets. Only
  # additive score bonuses (RS line +8, earnings drift +5/+3) were
  # net-positive. Keep disabled unless re-validated in bear market.
  # ============================================================

  # Follow-Through Day Confirmation (O'Neil market timing)
  follow_through_day:
    enabled: false
    min_rally_day: 4                   # FTD must occur on day 4+ of rally attempt
    min_gain_pct: 1.5                  # Index must gain 1.5%+ on FTD
    require_higher_volume: true        # Volume must be higher than prior day
    # State machine: CONFIRMED_UPTREND -> UPTREND_UNDER_PRESSURE -> MARKET_IN_CORRECTION -> RALLY_ATTEMPT
    states:
      confirmed_uptrend: "CONFIRMED_UPTREND"
      under_pressure: "UPTREND_UNDER_PRESSURE"
      correction: "MARKET_IN_CORRECTION"
      rally_attempt: "RALLY_ATTEMPT"

# RS Line New Highs (relative strength line making new highs before price)
rs_line:
  enabled: false
  lookback_weeks: 52                   # 52-week lookback for RS line new high
  bonus_points: 8                      # Bonus when RS line hits new high before price
  penalty_divergence: -5               # Penalty when price at new high but RS line isn't

# Earnings Surprise Drift (post-earnings momentum)
earnings_drift:
  enabled: false
  min_surprise_pct: 10                 # Minimum earnings beat to trigger drift signal
  drift_window_days: 60                # How long drift effect lasts after earnings
  bonus_points: 5                      # Score bonus for stocks in drift window
  volume_confirmation: true            # Require above-average volume on earnings day

# Portfolio Heat Monitor (total risk exposure)
portfolio_heat:
  enabled: false
  max_heat_pct: 15.0                   # Block new buys if total heat > 15%
  warning_heat_pct: 12.0               # Log warning at 12%
  # Heat = sum of (position_size_pct × distance_to_stop_pct)

# VIX-Regime Stops (volatility-adjusted stop losses)
vix_stops:
  enabled: false
  low_vix_threshold: 15                # VIX < 15: low volatility
  high_vix_threshold: 25               # VIX > 25: high volatility
  low_vix_stop_tighten: 0.80           # Tighten stops 20% in low vol (multiply by 0.8)
  high_vix_stop_widen: 1.20            # Widen stops 20% in high vol (multiply by 1.2)

# Volume Confirmation on Entry
volume_gate:
  enabled: false
  min_volume_ratio: 0.8                # Buy when volume >= 80% of 50-day average
  breakout_min_volume_ratio: 1.2       # Breakout entries need 1.2x volume (daily close underestimates intraday spikes)
  pre_breakout_min_volume_ratio: 0.6   # Pre-breakout can have lower volume (accumulation phase)

# Correlation-Aware Sizing
correlation_sizing:
  enabled: false
  lookback_days: 30                    # Rolling correlation window
  high_correlation_threshold: 0.70     # Reduce sizing when avg correlation > 0.7
  high_correlation_multiplier: 0.75    # 25% smaller position when correlated
  max_correlated_positions: 3          # Max positions with correlation > threshold

# Scale-In on Pullbacks (add to winners pulling back)
scale_in_pullbacks:
  enabled: false
  min_gain_pct: 10.0                   # Position must be up 10%+ to qualify
  pullback_pct: 3.0                    # Pullback of 3-5% from recent high
  max_pullback_pct: 5.0                # Don't add if pulled back more than 5%
  low_volume_ratio: 0.8                # Pullback should be on below-average volume
  add_pct: 30.0                        # Add 30% of original position size
  min_score: 70                        # Score must still be strong

# Morning Briefing Email
morning_briefing:
  enabled: false
  send_time_hour: 8                    # 8 AM Central Time
  send_time_minute: 0
  include_positions_at_risk: true      # Positions near stop loss
  include_approaching_pivots: true     # Stocks approaching breakout pivots
  include_earnings_this_week: true     # Stocks reporting earnings this week
  include_market_regime: true          # Current market regime summary

# Trade Journal / Performance Attribution
trade_journal:
  enabled: true
  track_signal_factors: true           # Record which factors drove each trade
  # Factors tracked: entry_type (pre-breakout, breakout, etc.), market_regime,
  # A/D count, FTD state, RS line new high, insider signal, sector momentum,
  # coiled spring, earnings drift

# Backtester Settings
backtester:
  workers: 12                         # Number of parallel workers for fetching price history
  disk_cache:
    enabled: true                     # Enable disk caching for price history
    database: null                    # Path to cache database (null = default: data/price_cache.db)
    expiry_days: 30                   # Days before cached data expires

# Strategy Profiles — preset trading configurations
# Used by both backtester and live AI trader
strategy_profiles:
  balanced:
    label: "Balanced (Default)"
    description: "Standard CANSLIM with ride-winners sell discipline"
    min_score: 72
    max_positions: 8
    max_single_position_pct: 25
    max_sector_pct: 50
    stop_loss_pct: 8.0
    bearish_stop_loss_pct: 7.0
    take_profit_pct: 75.0                 # Let winners run (was 40) — proven in #90
    trailing_stops:
      gain_50_plus: 20                    # Wider for big winners (was 15) — proven in #90
      gain_30_to_50: 15                   # Wider (was 12) — give room for consolidation
      gain_20_to_30: 10
      gain_10_to_20: 8
    seed_count: 5
    seed_pct: 10
    half_size_initial: true
    max_seed_investment_pct: 60            # E: Max 60% of capital in initial seeds (keep 40% for mid-year)
    quality_filters:
      min_c_score: 10
      min_l_score: 8
    scoring_weights:
      growth_projection: 0.20             # Reduced from 0.25 (less FMP-heavy component)
      canslim_score: 0.25
      momentum: 0.25                      # Increased from 0.20 (more price-based component)
      breakout: 0.20
      base_quality: 0.10
    # Ride-winners sell discipline — don't shake out profitable positions
    score_crash_drop_required: 25         # Require bigger score drop before selling (was 20)
    score_crash_ignore_if_profitable: 20  # Hold if up 20%+ through score dips (was 10%)

  growth:
    label: "Growth Mode"
    description: "Growth-focused ranking + ride winners as long as thesis holds"
    min_score: 68                       # Still lower than balanced (72) to catch emerging growth
    max_positions: 6                    # Concentrated — fewer, higher-conviction bets
    max_single_position_pct: 25         # Match balanced — avoid single-stock blow-ups
    max_sector_pct: 50                  # Match balanced
    stop_loss_pct: 8.0                  # Match balanced — cut losers fast
    bearish_stop_loss_pct: 7.0          # Match balanced — tighter in bear
    take_profit_pct: 75.0               # Let big winners ride (was 55, balanced 40)
    trailing_stops:
      gain_50_plus: 20                  # Wider — growth stocks swing more (balanced: 15)
      gain_30_to_50: 15                 # Wider — give room for consolidation (balanced: 12)
      gain_20_to_30: 10                 # Match balanced
      gain_10_to_20: 8                  # Match balanced
    seed_count: 4                       # Fewer seeds — more selective on day 1
    seed_pct: 10                        # Match balanced per-seed size
    half_size_initial: true             # Half-size entries — prove it first
    max_seed_investment_pct: 50          # E: Max 50% of capital in initial seeds (growth is more selective)
    quality_filters:
      min_c_score: 12                   # Higher C bar — demand strong earnings
      min_l_score: 10                   # Higher L bar — demand relative strength leaders
    scoring_weights:
      growth_projection: 0.35           # Heavier growth tilt (vs 0.25 balanced)
      canslim_score: 0.20
      momentum: 0.25                    # Heavier momentum tilt (vs 0.20 balanced)
      breakout: 0.15
      base_quality: 0.05
    # Growth mode ranking bonuses — these are the key differentiator
    c_score_weight: 1.3                 # Weight C score 30% more (earnings momentum)
    l_score_weight: 1.3                 # Weight L score 30% more (relative strength)
    n_score_weight: 1.2                 # Weight N score 20% more (new highs)
    eps_accel_bonus: 8                  # Extra bonus for EPS acceleration (vs 5 in balanced)
    pre_breakout_multiplier: 1.40       # Slightly larger pre-breakout positions (balanced: 1.30)
    # "Ride the thesis" — more lenient score-based sells for growth
    score_crash_drop_required: 25       # Require bigger score drop before selling (balanced: 20)
    score_crash_ignore_if_profitable: 20  # Hold if up 20%+ even on score dip (balanced: 10%)

  # Lab profile: Clone of balanced for Ralph Loop optimization experiments
  # SAFETY: NEVER modify balanced or growth profiles via automated optimization.
  # Only this lab profile should be changed by optimization scripts.
  lab:
    label: "Lab (Optimization)"
    description: "Experimental profile for automated parameter tuning"
    min_score: 72
    max_positions: 8
    max_single_position_pct: 25
    max_sector_pct: 50
    stop_loss_pct: 7.0                     # Iter 1: tighter stop (was 8.0)
    bearish_stop_loss_pct: 6.0             # Iter 1: tighter bearish stop (was 7.0)
    take_profit_pct: 75.0
    trailing_stops:
      gain_50_plus: 20
      gain_30_to_50: 15
      gain_20_to_30: 8                     # Iter 8: tighter trail (was 10)
      gain_10_to_20: 6                     # Iter 8: tighter trail (was 8)
    seed_count: 4                          # Iter 1: fewer seeds (was 5)
    seed_pct: 10
    half_size_initial: true
    max_seed_investment_pct: 50            # Iter 1: lower seed cap (was 60)
    quality_filters:
      min_c_score: 10                      # Reverted from Iter 4 (12 hurt returns)
      min_l_score: 8                       # Reverted from Iter 4 (10 hurt returns)
    scoring_weights:
      growth_projection: 0.20
      canslim_score: 0.25
      momentum: 0.25
      breakout: 0.20
      base_quality: 0.10
    score_crash_drop_required: 25              # Reverted: Iter 5 had zero impact
    score_crash_ignore_if_profitable: 20       # Reverted: Iter 5 had zero impact
