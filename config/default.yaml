# CANSLIM Analyzer Default Configuration
# Override these values in development.yaml or production.yaml

# Scanner Settings
scanner:
  workers: 8
  delay_min: 0.5  # seconds between API calls (min)
  delay_max: 1.0  # seconds between API calls (max)
  batch_size: 75  # Increased from 50 for better throughput
  max_retries: 2
  skip_fresh_stocks: true  # Skip stocks scanned within freshness_minutes
  freshness_minutes: 30  # Minimum age before re-scanning a stock

# Cache Settings
cache:
  # Redis cache
  redis:
    enabled: true
    host: localhost
    port: 6379
    db: 0
    decode_responses: true

  # Data freshness intervals (seconds)
  freshness_intervals:
    price: 0                # Always fetch (real-time)
    earnings: 86400         # 24 hours
    revenue: 86400          # 24 hours
    balance_sheet: 86400    # 24 hours
    key_metrics: 86400      # 24 hours
    analyst: 86400          # 24 hours
    earnings_surprise: 86400  # 24 hours
    weekly_history: 86400   # 24 hours
    institutional: 604800   # 7 days (1 week)
    insider_trading: 604800 # 7 days
    short_interest: 86400   # 24 hours

  # In-memory cache limits
  max_cached_tickers: 2500  # Need room for ~2100 tickers Ã— ~10 data types
  market_cache_duration: 14400  # 4 hours

# CANSLIM Scoring Weights
scoring:
  canslim:
    max_scores:
      C: 15  # Current Quarterly Earnings
      A: 15  # Annual Earnings Growth
      N: 15  # New Highs
      S: 15  # Supply & Demand
      L: 15  # Leader vs Laggard
      I: 10  # Institutional Ownership
      M: 15  # Market Direction

    # C Score (Current Earnings) weights
    c_weights:
      base_max: 10          # TTM growth
      acceleration_max: 5   # EPS acceleration bonus (increased - strong predictor)
      surprise_max: 2       # Earnings surprise bonus

    # Sector-adjusted growth thresholds
    # A 20% growth for Industrial is excellent; for Tech it's mediocre
    sector_thresholds:
      Technology:
        excellent: 30
        good: 20
      Healthcare:
        excellent: 25
        good: 15
      Industrials:
        excellent: 20
        good: 12
      Utilities:
        excellent: 12
        good: 8
      default:
        excellent: 25
        good: 15

    # Institutional ownership thresholds (expanded from 20-60 to 25-75)
    institutional:
      ideal_min: 25
      ideal_max: 75
      partial_min: 15
      partial_max: 85

    # A Score (Annual Earnings) weights
    a_weights:
      cagr_max: 12         # 3-year CAGR
      roe_max: 3           # ROE quality bonus

    # Thresholds
    thresholds:
      min_score: 30        # Skip stocks below this score
      roe_excellent: 25    # ROE >= 25% = excellent
      roe_good: 17         # ROE >= 17% = good
      ttm_growth_excellent: 25  # >= 25% TTM growth = max score

  growth_mode:
    max_scores:
      R: 20  # Revenue Growth
      F: 15  # Funding/Financial Health
      N: 15  # New Highs
      S: 15  # Supply & Demand
      L: 15  # Leader vs Laggard
      I: 10  # Institutional Ownership
      M: 10  # Market Direction

    # Growth Mode activation criteria
    criteria:
      min_revenue_growth: 50  # >= 50% YoY = high growth
      min_profit_margin: 0.01 # < 1% margin = early stage

# Market Direction Settings
market:
  indexes:
    SPY:
      weight: 0.50  # S&P 500 - broad market
      name: "S&P 500"
    QQQ:
      weight: 0.30  # NASDAQ 100 - tech/growth
      name: "NASDAQ 100"
    DIA:
      weight: 0.20  # Dow Jones - blue chips
      name: "Dow Jones"

  # Signal scoring
  signals:
    strong_bullish: 2
    bullish: 1
    neutral: 0
    bearish: -1

# AI Trader Settings
ai_trader:
  # Portfolio allocation limits
  allocation:
    min_cash_reserve_pct: 0.10    # Keep 10% cash reserve
    max_sector_allocation: 0.30   # Max 30% in any sector
    max_stocks_per_sector: 4      # Max 4 stocks per sector
    max_single_position: 0.15     # Max 15% in single stock
    min_score_to_buy: 65          # Minimum CANSLIM score to buy

  # Earnings calendar avoidance for non-CS stocks
  # CS stocks use their own allow_buy_days from coiled_spring config
  earnings:
    avoidance_days: 5             # Block non-CS stocks within 5 days of earnings
    cs_override: true             # Allow CS stocks to override avoidance

  # Analyst revision bonus (estimate revisions)
  analyst_revisions:
    enabled: true
    strong_up_threshold: 10       # >= 10% revision = strong up
    strong_up_bonus: 5            # +5 points
    mod_up_bonus: 3               # 5-10% revision = +3 points
    strong_down_threshold: -10    # <= -10% revision = strong down
    strong_down_penalty: -5       # -5 points
    mod_down_penalty: -2          # -5 to -10% revision = -2 points

  # Market regime detection (adjusts position sizes based on market conditions)
  market_regime:
    enabled: true
    bullish_threshold: 1.5        # weighted_signal >= this = bullish
    bearish_threshold: -0.5       # weighted_signal <= this = bearish
    bullish_max_position_pct: 15.0  # Allow larger positions in bull market
    neutral_max_position_pct: 12.0  # Standard position sizing
    bearish_max_position_pct: 8.0   # Smaller positions in bear market
    bearish_min_score_adj: 5       # Require 5 more points in bear market

  # Drawdown protection (reduce position sizes when portfolio is down)
  drawdown_protection:
    enabled: true
    level_1_threshold: 10         # >= 10% drawdown = reduce 25%
    level_1_multiplier: 0.75
    level_2_threshold: 15         # >= 15% drawdown = reduce 50%
    level_2_multiplier: 0.50

  # Sector rotation (bonus for leading sectors, penalty for lagging)
  sector_rotation:
    enabled: true
    leading_l_score: 10           # Avg L >= 10 = leading sector
    lagging_l_score: 5            # Avg L < 5 = lagging sector
    leading_bonus: 5              # +5 points for leading sectors
    lagging_penalty: -3           # -3 points for lagging sectors

  # Portfolio correlation (reduce position for concentrated sectors/industries)
  correlation:
    enabled: true
    sector_threshold: 3           # >= 3 stocks in sector = reduce position
    sector_multiplier: 0.85       # 15% smaller if same sector
    industry_threshold: 2         # >= 2 stocks in same industry = reduce more
    industry_multiplier: 0.70     # 30% smaller if same industry

  # Entry bonuses - pre-breakout is optimal entry (before the crowd)
  entry_bonuses:
    pre_breakout: 30     # 5-15% below pivot with base (best entry)
    at_pivot: 25         # 0-5% below pivot with base
    breakout: 20         # 0-5% above pivot (confirmed but slightly extended)

  # Position size multipliers based on entry type
  position_multipliers:
    pre_breakout: 1.30   # 30% larger for optimal pre-breakout entry
    at_pivot: 1.20       # 20% larger for at-pivot entries
    breakout: 1.15       # 15% larger for confirmed breakouts

  # Score crash sell requirements
  score_crash:
    consecutive_required: 2  # Require 2+ consecutive low scans before selling
    threshold: 50            # Score must be below this threshold
    drop_required: 20        # Score must have dropped by this much

  # Partial profit taking - lock in gains while letting winners run
  partial_profits:
    enabled: true
    threshold_25pct:
      gain_pct: 25         # Take partial at 25% gain
      sell_pct: 25         # Sell 25% of position
      min_score: 60        # Only if score still strong
    threshold_40pct:
      gain_pct: 40         # Take more at 40% gain
      sell_pct: 50         # Sell 50% total (25% additional)
      min_score: 60        # Only if score still strong

  # Momentum confirmation
  momentum_confirmation:
    rs_ratio_threshold: 0.95  # rs_3m must be >= rs_12m * 0.95
    penalty: 0.15             # 15% penalty to composite score if fading

  # Trailing stop loss thresholds
  trailing_stops:
    gain_50_plus:
      threshold: 0.50    # 50%+ gain
      stop_pct: 0.15     # 15% trailing stop
    gain_30_to_50:
      threshold: 0.30
      stop_pct: 0.12     # 12% trailing stop
    gain_20_to_30:
      threshold: 0.20
      stop_pct: 0.10     # 10% trailing stop
    gain_10_to_20:
      threshold: 0.10
      stop_pct: 0.08     # 8% trailing stop

  # Insider trading signal weights
  insider_signals:
    bullish_bonus: 5      # +5 points for bullish insiders
    bearish_penalty: -3   # -3 points for bearish insiders
    buy_sell_ratio: 1.5   # Buys > 1.5x sells = bullish
    # Insider cluster detection (multiple insiders buying)
    cluster_bonus: 8               # Bonus for 3+ insider buys
    high_value_cluster_bonus: 12   # Bonus for 3+ buys totaling $1M+
    csuite_bonus: 3                # Extra bonus for C-suite buying

  # Short interest settings
  short_interest:
    high_threshold: 0.20  # > 20% short interest
    high_penalty: -5
    medium_threshold: 0.10  # > 10% short interest
    medium_penalty: -2

  # Short squeeze detection
  # High short interest can be opportunity with right setup
  short_squeeze:
    enabled: true
    min_short_pct: 20             # Min short interest to consider squeeze
    min_l_score: 10               # Must have strong relative strength
    squeeze_bonus: 5              # Bonus for squeeze setup (instead of penalty)

# Coiled Spring / Earnings Catalyst Detection
# Identifies stocks with explosive earnings potential based on:
# - Long consolidation (stored energy)
# - Consistent earnings beats
# - Low institutional ownership (room to buy)
# - Rising relative strength
coiled_spring:
  # ALL criteria must be met to qualify
  thresholds:
    min_weeks_in_base: 15       # Long consolidation = stored energy
    min_beat_streak: 3          # Consistent execution
    min_c_score: 10             # Strong current earnings (relaxed from 12)
    min_total_score: 55         # Quality stock
    max_institutional_pct: 75   # Room for institutions to buy (relaxed from 50)
    min_l_score: 6              # Rising relative strength (relaxed from 8)

  # Relaxed thresholds for PRE-BREAKOUT candidates (haven't had catalyst yet)
  pre_breakout_thresholds:
    min_c_score: 5              # Lower C requirement (catalyst hasn't happened)
    min_total_score: 48         # Lower total (will improve after earnings)
    min_beat_streak: 3          # Same consistency requirement

  # Earnings timing
  earnings_window:
    alert_days: 14              # Start tracking 14 days out
    allow_buy_days: 7           # Allow buys up to 7 days before (override 3-day block)
    block_days: 1               # Never buy within 1 day of earnings

  # Scoring bonus
  scoring:
    base_bonus: 20              # Base bonus when criteria met
    long_base_bonus: 10         # Extra for 20+ week base
    strong_beat_bonus: 5        # Extra for 5+ consecutive beats
    max_bonus: 35               # Cap total CS bonus

  # Quality ranking weights (used to rank candidates, higher = better)
  ranking_weights:
    weeks_in_base: 1.5          # Longer base = more stored energy
    beat_streak: 3.0            # Consistency is key
    l_score: 2.0                # Relative strength momentum
    total_score: 0.5            # Overall quality
    low_inst_bonus: 10          # Bonus if inst < 30% (room to run)
    pre_breakout_bonus: 15      # Bonus if NOT already breaking out (ideal entry)
    extended_penalty: -20       # Penalty if already extended (>5% above pivot with high volume)

  # Alert settings (prevent overload)
  alerts:
    enabled: true
    max_per_day: 5              # Maximum alerts per day (increased from 3)
    cooldown_hours: 8           # Hours between alerts for same ticker
    include_in_email: true
    min_price_change_pct: 3     # Require 3% price move from previous alert to re-alert same ticker

  # Position sizing
  position_multiplier: 1.25     # 25% larger position for CS plays

  # Outcome tracking (auto-update CS alert outcomes after earnings)
  outcome_tracking:
    enabled: true
    check_days_after_earnings: 3   # Days to wait after earnings to check outcome
    thresholds:
      big_win_pct: 15    # >= 15% gain = big_win
      win_pct: 5         # >= 5% gain = win
      loss_pct: -5       # <= -5% = loss
      # Between -5% and +5% = flat

# Watchlist Alerts
watchlist:
  alerts:
    enabled: true
    check_after_scan: true       # Check alerts after each scan completes
    cooldown_hours: 24           # Don't re-alert for same item within 24h

# Technical Analysis Settings
technical:
  # Base pattern detection
  base_patterns:
    flat_base:
      min_weeks: 5
      max_range_pct: 0.15  # < 15% weekly range
    cup_with_handle:
      min_decline_pct: 0.15  # >= 15% decline
      handle_min_pct: 0.05   # 5-15% handle pullback
      handle_max_pct: 0.15
      handle_max_weeks: 4
    double_bottom:
      min_recovery_pct: 0.10  # >= 10% recovery between lows
      low_tolerance_pct: 0.03 # Lows within 3% of each other

  # Breakout detection
  breakout:
    volume_threshold: 1.5     # 1.5x average volume
    pivot_proximity_pct: 0.05  # Within 5% of pivot
    confirmation_score: 60     # Min volume confirmation score

# Stock Universe Settings
universe:
  sources:
    - sp500        # S&P 500
    - sp400        # S&P MidCap 400
    - sp600        # S&P SmallCap 600
    - russell2000  # Russell 2000

  # Duplicate ticker handling
  duplicates:
    GOOG: GOOGL  # Keep GOOGL, filter GOOG

# API Rate Limits
api:
  fmp:
    rate_limit: 300  # calls per minute
    timeout: 10      # seconds
  yahoo:
    delay: 0.3       # seconds between calls
    timeout: 15      # seconds
  finviz:
    delay: 1.0       # seconds between scrapes
    timeout: 10      # seconds

# API Response Limits
api_limits:
  default_page_size: 50
  max_page_size: 500
  default_history_days: 30
  max_history_days: 365

# Scoring Defaults
scoring_defaults:
  min_displayable_score: 30
  default_market_score: 10

# Retry Settings
retry:
  max_attempts: 3
  base_delay_seconds: 1
  max_delay_seconds: 30

# Alert Thresholds
alerts:
  price_change_significant_pct: 5
  volume_spike_ratio: 2.0

# Notifications
notifications:
  # Webhook notifications (push notifications via ntfy.sh, Pushover, etc.)
  webhook:
    enabled: true
    # Set CANSLIM_WEBHOOK_URL environment variable to enable
    # Example: https://ntfy.sh/your-topic
    url_env_var: "CANSLIM_WEBHOOK_URL"
    priority: "high"             # Priority for CS alerts

  # Weekly performance email (sent Saturday 9 AM)
  weekly_email:
    enabled: true
    day_of_week: "sat"           # Day to send (mon, tue, wed, thu, fri, sat, sun)
    hour: 9                      # Hour to send (0-23)

# Database Settings
database:
  # Indexes for optimization
  indexes:
    - name: ix_stocks_canslim
      column: canslim_score
    - name: ix_stocks_price
      column: current_price
    - name: ix_stocks_score_price
      columns: [canslim_score, current_price]
